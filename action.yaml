name: 'OAS3 Linter'
description: 'Validates Open API Specification (OAS3) YAML files using @apifellows Linter'
author: '@apifellows'

inputs:
  file-path:
    description: 'Path to the OpenAPI 3 YAML file in your repository to validate'
    required: true
  continue-on-specification-error:
    description: 'Continue CI/CD execution if the specification validation fails (true/false)'
    required: false
    default: 'false'
  continue-on-server-error:
    description: 'Continue CI/CD execution if @apifellows service has an error or is unavailable (true/false)'
    required: false
    default: 'false'
  version:
    description: '@apifellows OAS3 Linter Version (e.g., v1, v2)'
    required: false
    default: 'v1'
  
outputs:
  result:
    description: 'Validation result (success, warning, error)'
    value: ${{ steps.validate.outputs.result }}
  status-code:
    description: 'HTTP status code from the API'
    value: ${{ steps.validate.outputs.status_code }}

runs:
  using: 'composite'
  steps:
    - name: Validate OpenAPI Specification
      id: validate
      shell: bash
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘            @apifellows CI/CD Quality Gate for: OAS3              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        FILE_PATH="${{ inputs.file-path }}"
        VERSION="${{ inputs.version }}"
        CONTINUE_ON_ERROR="${{ inputs.continue-on-server-error }}"
        CONTINUE_ON_SPEC_ERROR="${{ inputs.continue-on-specification-error }}"
        API_URL="https://api.apifellows.com/linter-oas3/${VERSION}/oas3/checkfile"
        
        echo "ðŸ“‹ Configuration:"
        echo "   â€¢ File: $FILE_PATH"
        echo "   â€¢ API Version: $VERSION"
        echo "   â€¢ API URL: $API_URL"
        echo "   â€¢ Continue on Server Error: $CONTINUE_ON_ERROR"
        echo "   â€¢ Continue on Specification Error: $CONTINUE_ON_SPEC_ERROR"
        echo ""
        
        # Check if file exists
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ ERROR: File not found"
          echo "   Path: $FILE_PATH"
          echo ""
          echo "result=error" >> $GITHUB_OUTPUT
          echo "status_code=0" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ“ File found: $(basename "$FILE_PATH")"
        echo ""
        echo "ðŸ” Validating specification..."
        echo ""
        
        # Make API request with proper content type header
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -H "Accept: application/json" \
          -F "file=@${FILE_PATH};type=application/x-yaml" \
          "$API_URL")
        
        # Extract status code (last line)
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        
        # Extract body (everything except last line)
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        echo "status_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¡ API Response: HTTP $HTTP_CODE"
        echo ""
        
        # Handle different status codes
        case $HTTP_CODE in
          200)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… VALIDATION SUCCESSFUL"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Your OpenAPI specification is valid!"
            echo ""
            echo "ðŸ”— For detailed metrics, upload your file at:"
            echo "   https://www.apifellows.com/rest-api-linter"
            echo ""
            
            echo "result=success" >> $GITHUB_OUTPUT
            exit 0
            ;;
            
          400)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ CLIENT ERROR - Invalid Request"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The file could not be processed. Please check:"
            echo "  â€¢ File format is valid YAML"
            echo "  â€¢ File extension is .yaml or .yml"
            echo "  â€¢ File is not empty"
            echo ""
            
            # Try to extract error message from response
            ERROR_MSG=$(echo "$BODY" | grep -o '"status_message":"[^"]*"' | cut -d'"' -f4 || echo "Unknown error")
            echo "Server message: $ERROR_MSG"
            echo ""
            
            echo "result=error" >> $GITHUB_OUTPUT
            exit 1
            ;;
            
          422)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ VALIDATION FAILED - Issues Found"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Your OpenAPI specification contains validation errors."
            echo ""
            echo "ðŸ”— For detailed error report, upload your file at:"
            echo "   https://www.apifellows.com/rest-api-linter"
            echo ""
            
            if [ "$CONTINUE_ON_SPEC_ERROR" = "true" ]; then
              echo "âš ï¸  Continuing execution (continue-on-specification-error: true)"
              echo ""
              echo "result=warning" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Failing build (continue-on-specification-error: false)"
              echo ""
              echo "ðŸ’¡ Tip: Set 'continue-on-specification-error: true' to ignore validation errors"
              echo ""
              echo "result=error" >> $GITHUB_OUTPUT
              exit 1
            fi
            ;;
            
          5*)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸ”§ SERVER ERROR"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The linter service encountered an error (HTTP $HTTP_CODE)."
            echo ""
            
            if [ "$CONTINUE_ON_ERROR" = "true" ]; then
              echo "âš ï¸  Continuing execution (continue-on-server-error: true)"
              echo ""
              echo "result=warning" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Failing build (continue-on-server-error: false)"
              echo ""
              echo "ðŸ’¡ Tip: Set 'continue-on-server-error: true' to ignore server errors"
              echo ""
              echo "result=error" >> $GITHUB_OUTPUT
              exit 1
            fi
            ;;
            
          *)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ UNEXPECTED RESPONSE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Received unexpected HTTP status code: $HTTP_CODE"
            echo ""
            echo "Response body:"
            echo "$BODY"
            echo ""
            echo "result=error" >> $GITHUB_OUTPUT
            exit 1
            ;;
        esac

branding:
  icon: 'check-circle'
  color: 'green'
